# azure-pipelines-backend.yml
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - '**/SaveTheCat.Backend/**' # Solo se ejecuta si cambias el backend

variables:
  buildConfiguration: 'Release'
  backendProjectPath: '**/SaveTheCat.Api.csproj'
  azureSubscription: 'savethecat-prod-sc' # El nombre que pusiste en Fase 1
  webAppName: 'savethecat-prod-api-001'

pool:
  vmImage: 'windows-latest'

steps:
# 1. Restaurar herramientas locales de .NET (incluye dotnet-ef)
- task: DotNetCoreCLI@2
  displayName: 'Restore .NET Tools'
  inputs:
    command: custom
    custom: tool
    arguments: 'restore'
    workingDirectory: '$(System.DefaultWorkingDirectory)/SaveTheCat.Backend'

# 2. Restaurar dependencias
- task: DotNetCoreCLI@2
  displayName: 'Restore Nuget Packages'
  inputs:
    command: 'restore'
    projects: '$(backendProjectPath)'

# 3. Compilar el proyecto
- task: DotNetCoreCLI@2
  displayName: 'Build Backend'
  inputs:
    command: 'build'
    projects: '$(backendProjectPath)'
    arguments: '--configuration $(buildConfiguration) --no-restore'

# 4. Generar Bundle de Migraciones (Para actualizar la DB automáticamente)
- task: CmdLine@2
  displayName: 'Build EF Core Migrations Bundle'
  inputs:
    script: |
      cd $(System.DefaultWorkingDirectory)/SaveTheCat.Backend/SaveTheCat.Api
      dotnet ef migrations bundle --self-contained -r win-x64 -o $(Build.ArtifactStagingDirectory)/efbundle.exe
    env:
      DefaultConnection: 'Server=(localdb)\\mssqllocaldb;Database=TempDb;Trusted_Connection=True;'

# 5. Publicar la API (Generar el .zip)
- task: DotNetCoreCLI@2
  displayName: 'Publish API'
  inputs:
    command: 'publish'
    projects: '$(backendProjectPath)'
    publishWebProjects: true
    arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/drop'
    zipAfterPublish: true

# 6. Desplegar al App Service (API)
- task: AzureWebApp@1
  displayName: 'Deploy to Azure App Service'
  inputs:
    azureSubscription: '$(azureSubscription)'
    appType: 'webApp'
    appName: '$(webAppName)'
    package: '$(Build.ArtifactStagingDirectory)/drop/*.zip'

# 7. Ejecutar Migraciones en Base de Datos (SQL Database)
# NOTA: Asegúrate de que el App Service o el Agente tenga acceso a la DB.
# Una forma más segura es usar las credenciales desde KeyVault o Variables de Pipeline.
- task: AzureCLI@2
  displayName: 'Apply Database Migrations'
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'pscore'
    scriptLocation: 'inlineScript'
    inlineScript: |
      # Obtener Connection String desde el App Service (Configuración)
      $conn = az webapp config connection-string list --resource-group savethecat-prod-rg --name $(webAppName) --query "[?name=='DefaultConnection'].value" -o tsv
      
      # Ejecutar el bundle contra la base de datos
      & "$(Build.ArtifactStagingDirectory)/efbundle.exe" --connection "$conn"