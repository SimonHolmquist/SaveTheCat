# azure-pipelines-backend.yml

# Disparador: Se ejecuta solo cuando hay cambios en la carpeta del backend en la rama main
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - SaveTheCat.Backend/*

# Agente: Usar una máquina virtual de Ubuntu
pool:
  vmImage: 'ubuntu-latest'

# Variables
variables:
  solution: '**/SaveTheCat.sln'
  buildConfiguration: 'Release'
  
  # Ruta al proyecto de Infraestructura (para migraciones)
  projectInfrastructure: 'SaveTheCat.Backend/SaveTheCat.Infrastructure/SaveTheCat.Infrastructure.csproj'
  
  # Ruta al proyecto de API (para despliegue)
  projectApi: 'SaveTheCat.Backend/SaveTheCat.Api/SaveTheCat.Api.csproj'
  
  # Nombre del App Service en Azure (de tu imagen)
  azureAppServiceName: 'savethecat-prod-api-001'
  
  # Nombre de la Conexión de Servicio (la crearemos/autorizaremos en el siguiente paso)
  azureSubscription: 'savethecat-sc' 

# Fases del Pipeline
stages:
- stage: Build
  displayName: 'Build .NET'
  jobs:
  - job: Build
    displayName: 'Build & Publish Artifacts'
    steps:
    # 1. Instalar .NET 8 SDK
    - task: UseDotNet@2
      displayName: 'Use .NET 8.0'
      inputs:
        packageType: 'sdk'
        version: '8.x'

    # 2. Restaurar paquetes NuGet
    - task: DotNetCoreCLI@2
      displayName: 'Restore Solution'
      inputs:
        command: 'restore'
        projects: $(solution)
        feedsToUse: 'select'

    # 3. Compilar la solución en modo Release
    - task: DotNetCoreCLI@2
      displayName: 'Build Solution'
      inputs:
        command: 'build'
        projects: $(solution)
        arguments: '--configuration $(buildConfiguration)'

    # 4. Publicar la API (el proyecto web)
    - task: DotNetCoreCLI@2
      displayName: 'Publish API'
      inputs:
        command: 'publish'
        publishWebProjects: false
        projects: $(projectApi)
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/api'
        zipAfterPublish: true

    # 5. Publicar el proyecto de Migraciones (Infrastructure)
    - task: DotNetCoreCLI@2
      displayName: 'Publish Migrator'
      inputs:
        command: 'publish'
        publishWebProjects: false
        projects: $(projectInfrastructure)
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/migrator'
        zipAfterPublish: false # No necesitamos zipear esto

    # 6. Publicar el ZIP de la API como un artefacto
    - task: PublishBuildArtifacts@1
      displayName: 'Publish API Artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/api'
        ArtifactName: 'api-drop'

    # 7. Publicar los archivos de migración como otro artefacto
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Migrator Artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/migrator'
        ArtifactName: 'migrator-drop'

- stage: Deploy
  displayName: 'Deploy to Production'
  dependsOn: Build
  jobs:
  # TRABAJO 1: Ejecutar las migraciones de la base de datos
  - job: Deploy_Migrations
    displayName: 'Deploy DB Migrations'
    steps:
    - task: UseDotNet@2
      displayName: 'Use .NET 8.0'
      inputs:
        packageType: 'sdk'
        version: '8.x'
    
    - task: DownloadBuildArtifacts@1
      displayName: 'Download Migrator Artifact'
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'migrator-drop'
        downloadPath: '$(System.ArtifactsDirectory)'

    # Instala la herramienta de línea de comandos de EF Core
    - task: DotNetCoreCLI@2
      displayName: 'Install dotnet-ef tool'
      inputs:
        command: 'custom'
        custom: 'tool'
        arguments: 'install --global dotnet-ef'

    # Ejecuta la migración
    - task: DotNetCoreCLI@2
      displayName: 'Run EF Migrations'
      inputs:
        command: 'custom'
        custom: 'ef'
        # $(System.ArtifactsDirectory) es donde se descargó el artefacto
        arguments: 'database update --project $(System.ArtifactsDirectory)/migrator/SaveTheCat.Infrastructure.csproj --connection "$(SqlConnectionString)"'
      env:
        # Esta variable secreta $(SqlConnectionString) la crearemos en Azure DevOps
        SqlConnectionString: $(SqlConnectionString) 

  # TRABAJO 2: Desplegar la API (solo si las migraciones funcionaron)
  - job: Deploy_API
    displayName: 'Deploy API App Service'
    dependsOn: Deploy_Migrations # Depende del éxito del trabajo anterior
    steps:
    - task: UseDotNet@2
      displayName: 'Use .NET 8.0'
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - task: DownloadBuildArtifacts@1
      displayName: 'Download API Artifact'
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'api-drop'
        downloadPath: '$(System.ArtifactsDirectory)'
    
    # Tarea de despliegue a Azure
    - task: AzureWebApp@1
      displayName: 'Deploy API to Azure App Service'
      inputs:
        azureSubscription: $(azureSubscription)
        appType: 'webAppLinux' # <-- CAMBIA a 'webApp' si creaste tu App Service en Windows
        appName: $(azureAppServiceName)
        package: '$(System.ArtifactsDirectory)/**/*.zip'
        runtimeStack: 'DOTNETCORE|8.0'